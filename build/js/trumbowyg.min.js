jQuery.trumbowyg={langs:{en:{viewHTML:"View HTML",undo:"Undo",redo:"Redo",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",del:"Deleted",superscript:"Superscript",subscript:"Subscript",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",removeformat:"Remove format",fullscreen:"Fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",required:"Required",description:"Description",title:"Title",text:"Text",target:"Target",width:"Width"}},plugins:{},svgPath:null,hideButtonTexts:null},Object.defineProperty(jQuery.trumbowyg,"defaultOptions",{value:{lang:"en",fixedBtnPane:!1,fixedFullWidth:!1,autogrow:!1,autogrowOnEnter:!1,imageWidthModalEdit:!1,prefix:"trumbowyg-",semantic:!0,resetCss:!1,removeformatPasted:!1,tagsToRemove:[],tagsToKeep:["hr","img","embed","iframe","input"],btns:[["viewHTML"],["undo","redo"],["formatting"],["strong","em","del"],["superscript","subscript"],["link"],["insertImage"],["justifyLeft","justifyCenter","justifyRight","justifyFull"],["unorderedList","orderedList"],["horizontalRule"],["removeformat"],["fullscreen"]],btnsDef:{},inlineElementsSelector:"a,abbr,acronym,b,caption,cite,code,col,dfn,dir,dt,dd,em,font,hr,i,kbd,li,q,span,strikeout,strong,sub,sup,u",pasteHandlers:[],plugins:{},urlProtocol:!1,minimalLinks:!1},writable:!1,enumerable:!0,configurable:!1}),function(navigator,window,document,$){"use strict";$.fn.trumbowyg=function(options,params){if(options===Object(options)||!options)return this.each(function(){$(this).data("trumbowyg")||$(this).data("trumbowyg",new Trumbowyg(this,options))});if(1===this.length)try{var t=$(this).data("trumbowyg");switch(options){case"execCmd":return t.execCmd(params.cmd,params.param,params.forceCss);case"openModal":return t.openModal(params.title,params.content);case"closeModal":return t.closeModal();case"openModalInsert":return t.openModalInsert(params.title,params.fields,params.callback);case"saveRange":return t.saveRange();case"getRange":return t.range;case"getRangeText":return t.getRangeText();case"restoreRange":return t.restoreRange();case"enable":return t.setDisabled(!1);case"disable":return t.setDisabled(!0);case"toggle":return t.toggle();case"destroy":return t.destroy();case"empty":return t.empty();case"html":return t.html(params)}}catch(c){}return!1};var Trumbowyg=function(editorElem,options){var t=this,$trumbowyg=$.trumbowyg;t.doc=editorElem.ownerDocument||document,t.$ta=$(editorElem),t.$c=$(editorElem),null!=(options=options||{}).lang||null!=$trumbowyg.langs[options.lang]?t.lang=$.extend(!0,{},$trumbowyg.langs.en,$trumbowyg.langs[options.lang]):t.lang=$trumbowyg.langs.en,t.hideButtonTexts=null!=$trumbowyg.hideButtonTexts?$trumbowyg.hideButtonTexts:options.hideButtonTexts;var svgPathOption=null!=$trumbowyg.svgPath?$trumbowyg.svgPath:options.svgPath;if(t.hasSvg=!1!==svgPathOption,t.svgPath=t.doc.querySelector("base")?window.location.href.split("#")[0]:"",0===$("#trumbowyg-icons",t.doc).length&&!1!==svgPathOption){if(null==svgPathOption){for(var scriptElements=document.getElementsByTagName("script"),i=0;i<scriptElements.length;i+=1){var source=scriptElements[i].src,matches=source.match("trumbowyg(.min)?.js");null!=matches&&(svgPathOption=source.substring(0,source.indexOf(matches[0]))+"../img/icons.svg")}null==svgPathOption&&console.warn("You must define svgPath: https://goo.gl/CfTY9U")}var div=t.doc.createElement("div");div.id="trumbowyg-icons",t.doc.body.insertBefore(div,t.doc.body.childNodes[0]),$.ajax({async:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"xml",crossDomain:!0,url:svgPathOption,data:null,beforeSend:null,complete:null,success:function(data){div.innerHTML=(new XMLSerializer).serializeToString(data.documentElement)}})}var h=t.lang.header,isBlinkFunction=function(){return(window.chrome||window.Intl&&Intl.v8BreakIterator)&&"CSS"in window};t.btnsDef={viewHTML:{fn:"toggle",class:"trumbowyg-not-disable"},undo:{isSupported:isBlinkFunction,key:"Z"},redo:{isSupported:isBlinkFunction,key:"Y"},p:{fn:"formatBlock"},blockquote:{fn:"formatBlock"},h1:{fn:"formatBlock",title:h+" 1"},h2:{fn:"formatBlock",title:h+" 2"},h3:{fn:"formatBlock",title:h+" 3"},h4:{fn:"formatBlock",title:h+" 4"},subscript:{tag:"sub"},superscript:{tag:"sup"},bold:{key:"B",tag:"b"},italic:{key:"I",tag:"i"},underline:{tag:"u"},strikethrough:{tag:"strike"},strong:{fn:"bold",key:"B"},em:{fn:"italic",key:"I"},del:{fn:"strikethrough"},createLink:{key:"K",tag:"a"},unlink:{},insertImage:{},justifyLeft:{tag:"left",forceCss:!0},justifyCenter:{tag:"center",forceCss:!0},justifyRight:{tag:"right",forceCss:!0},justifyFull:{tag:"justify",forceCss:!0},unorderedList:{fn:"insertUnorderedList",tag:"ul"},orderedList:{fn:"insertOrderedList",tag:"ol"},horizontalRule:{fn:"insertHorizontalRule"},removeformat:{},fullscreen:{class:"trumbowyg-not-disable"},close:{fn:"destroy",class:"trumbowyg-not-disable"},formatting:{dropdown:["p","blockquote","h1","h2","h3","h4"],ico:"p"},link:{dropdown:["createLink","unlink"]}},t.o=$.extend(!0,{},$trumbowyg.defaultOptions,options),t.o.hasOwnProperty("imgDblClickHandler")||(t.o.imgDblClickHandler=t.getDefaultImgDblClickHandler()),t.urlPrefix=t.setupUrlPrefix(),t.disabled=t.o.disabled||"TEXTAREA"===editorElem.nodeName&&editorElem.disabled,options.btns?t.o.btns=options.btns:t.o.semantic||(t.o.btns[3]=["bold","italic","underline","strikethrough"]),$.each(t.o.btnsDef,function(btnName,btnDef){t.addBtnDef(btnName,btnDef)}),t.eventNamespace="trumbowyg-event",t.keys=[],t.tagToButton={},t.tagHandlers=[],t.pasteHandlers=[].concat(t.o.pasteHandlers),t.isIE=-1!==navigator.userAgent.indexOf("MSIE")||-1!==navigator.appVersion.indexOf("Trident/"),t.init()};Trumbowyg.prototype={DEFAULT_SEMANTIC_MAP:{b:"strong",i:"em",s:"del",strike:"del",div:"p"},init:function(){var t=this;t.height=t.$ta.height(),t.initPlugins();try{t.doc.execCommand("enableObjectResizing",!1,!1),t.doc.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){}t.buildEditor(),t.buildBtnPane(),t.fixedBtnPaneEvents(),t.buildOverlay(),setTimeout(function(){t.disabled&&t.setDisabled(!0),t.$c.trigger("tbwinit")})},addBtnDef:function(btnName,btnDef){this.btnsDef[btnName]=btnDef},setupUrlPrefix:function(){var protocol=this.o.urlProtocol;if(protocol)return"string"!=typeof protocol?"https://":/:\/\/$/.test(protocol)?protocol:protocol+"://"},buildEditor:function(){var t=this,prefix=t.o.prefix,html="";t.$box=$("<div/>",{class:prefix+"box "+prefix+"editor-visible "+prefix+t.o.lang+" trumbowyg"}),t.isTextarea=t.$ta.is("textarea"),t.isTextarea?(html=t.$ta.val(),t.$ed=$("<div/>"),t.$box.insertAfter(t.$ta).append(t.$ed,t.$ta)):(t.$ed=t.$ta,html=t.$ed.html(),t.$ta=$("<textarea/>",{name:t.$ta.attr("id"),height:t.height}).val(html),t.$box.insertAfter(t.$ed).append(t.$ta,t.$ed),t.syncCode()),t.$ta.addClass(prefix+"textarea").attr("tabindex",-1),t.$ed.addClass(prefix+"editor").attr({contenteditable:!0,dir:t.lang._dir||"ltr"}).html(html),t.o.tabindex&&t.$ed.attr("tabindex",t.o.tabindex),t.$c.is("[placeholder]")&&t.$ed.attr("placeholder",t.$c.attr("placeholder")),t.$c.is("[spellcheck]")&&t.$ed.attr("spellcheck",t.$c.attr("spellcheck")),t.o.resetCss&&t.$ed.addClass(prefix+"reset-css"),t.o.autogrow||t.$ta.add(t.$ed).css({height:t.height}),t.semanticCode(),t.o.autogrowOnEnter&&t.$ed.addClass(prefix+"autogrow-on-enter");var debounceButtonPaneStatus,ctrl=!1,composition=!1;t.$ed.on("dblclick","img",t.o.imgDblClickHandler).on("keydown",function(e){if((e.ctrlKey||e.metaKey)&&!e.altKey){ctrl=!0;var key=t.keys[String.fromCharCode(e.which).toUpperCase()];try{return t.execCmd(key.fn,key.param),!1}catch(c){}}}).on("compositionstart compositionupdate",function(){composition=!0}).on("keyup compositionend",function(e){if("compositionend"===e.type)composition=!1;else if(composition)return;var keyCode=e.which;if(!(keyCode>=37&&keyCode<=40)){if(!e.ctrlKey&&!e.metaKey||89!==keyCode&&90!==keyCode)if(ctrl||17===keyCode)void 0===e.which&&t.semanticCode(!1,!1,!0);else{var compositionEndIE=!t.isIE||"compositionend"===e.type;t.semanticCode(!1,compositionEndIE&&13===keyCode),t.$c.trigger("tbwchange")}else t.semanticCode(!1,!0),t.$c.trigger("tbwchange");setTimeout(function(){ctrl=!1},50)}}).on("mouseup keydown keyup",function(e){(!e.ctrlKey&&!e.metaKey||e.altKey)&&setTimeout(function(){ctrl=!1},50),clearTimeout(debounceButtonPaneStatus),debounceButtonPaneStatus=setTimeout(function(){t.updateButtonPaneStatus()},50)}).on("focus blur",function(e){if(t.$c.trigger("tbw"+e.type),"blur"===e.type&&$("."+prefix+"active-button",t.$btnPane).removeClass(prefix+"active-button "+prefix+"active"),t.o.autogrowOnEnter){if(t.autogrowOnEnterDontClose)return;"focus"===e.type?(t.autogrowOnEnterWasFocused=!0,t.autogrowEditorOnEnter()):t.o.autogrow||(t.$ed.css({height:t.$ed.css("min-height")}),t.$c.trigger("tbwresize"))}}).on("cut drop",function(){setTimeout(function(){t.semanticCode(!1,!0),t.$c.trigger("tbwchange")},0)}).on("paste",function(e){if(t.o.removeformatPasted){e.preventDefault(),window.getSelection&&window.getSelection().deleteFromDocument&&window.getSelection().deleteFromDocument();try{var text=window.clipboardData.getData("Text");try{t.doc.selection.createRange().pasteHTML(text)}catch(c){t.doc.getSelection().getRangeAt(0).insertNode(t.doc.createTextNode(text))}t.$c.trigger("tbwchange",e)}catch(d){t.execCmd("insertText",(e.originalEvent||e).clipboardData.getData("text/plain"))}}$.each(t.pasteHandlers,function(i,pasteHandler){pasteHandler(e)}),setTimeout(function(){t.semanticCode(!1,!0),t.$c.trigger("tbwpaste",e),t.$c.trigger("tbwchange")},0)}),t.$ta.on("keyup",function(){t.$c.trigger("tbwchange")}).on("paste",function(){setTimeout(function(){t.$c.trigger("tbwchange")},0)}),t.$box.on("keydown",function(e){if(27===e.which&&1===$("."+prefix+"modal-box",t.$box).length)return t.closeModal(),!1})},autogrowEditorOnEnter:function(){var t=this;t.$ed.removeClass("autogrow-on-enter");var oldHeight=t.$ed[0].clientHeight;t.$ed.height("auto");var totalHeight=t.$ed[0].scrollHeight;t.$ed.addClass("autogrow-on-enter"),oldHeight!==totalHeight&&(t.$ed.height(oldHeight),setTimeout(function(){t.$ed.css({height:totalHeight}),t.$c.trigger("tbwresize")},0))},buildBtnPane:function(){var t=this,prefix=t.o.prefix,$btnPane=t.$btnPane=$("<div/>",{class:prefix+"button-pane"});$.each(t.o.btns,function(i,btnGrp){$.isArray(btnGrp)||(btnGrp=[btnGrp]);var $btnGroup=$("<div/>",{class:prefix+"button-group "+(btnGrp.indexOf("fullscreen")>=0?prefix+"right":"")});$.each(btnGrp,function(i,btn){try{t.isSupportedBtn(btn)&&$btnGroup.append(t.buildBtn(btn))}catch(c){}}),$btnGroup.html().trim().length>0&&$btnPane.append($btnGroup)}),t.$box.prepend($btnPane)},buildBtn:function(btnName){var t=this,prefix=t.o.prefix,btn=t.btnsDef[btnName],isDropdown=btn.dropdown,hasIcon=null==btn.hasIcon||btn.hasIcon,textDef=t.lang[btnName]||btnName,$btn=$("<button/>",{type:"button",class:prefix+btnName+"-button "+(btn.class||"")+(hasIcon?"":" "+prefix+"textual-button"),html:t.hasSvg&&hasIcon?'<svg><use xlink:href="'+t.svgPath+"#"+prefix+(btn.ico||btnName).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>':t.hideButtonTexts?"":btn.text||btn.title||t.lang[btnName]||btnName,title:(btn.title||btn.text||textDef)+(btn.key?" (Ctrl + "+btn.key+")":""),tabindex:-1,mousedown:function(){return isDropdown&&!$("."+btnName+"-"+prefix+"dropdown",t.$box).is(":hidden")||$("body",t.doc).trigger("mousedown"),!((t.$btnPane.hasClass(prefix+"disable")||t.$box.hasClass(prefix+"disabled"))&&!$(this).hasClass(prefix+"active")&&!$(this).hasClass(prefix+"not-disable"))&&(t.execCmd((!isDropdown?btn.fn:"dropdown")||btnName,btn.param||btnName,btn.forceCss),!1)}});if(isDropdown){$btn.addClass(prefix+"open-dropdown");var dropdownPrefix=prefix+"dropdown",dropdownOptions={class:dropdownPrefix+"-"+btnName+" "+dropdownPrefix+" "+prefix+"fixed-top"};dropdownOptions["data-"+dropdownPrefix]=btnName;var $dropdown=$("<div/>",dropdownOptions);$.each(isDropdown,function(i,def){t.btnsDef[def]&&t.isSupportedBtn(def)&&$dropdown.append(t.buildSubBtn(def))}),t.$box.append($dropdown.hide())}else btn.key&&(t.keys[btn.key]={fn:btn.fn||btnName,param:btn.param||btnName});return isDropdown||(t.tagToButton[(btn.tag||btnName).toLowerCase()]=btnName),$btn},buildSubBtn:function(btnName){var t=this,prefix=t.o.prefix,btn=t.btnsDef[btnName],hasIcon=null==btn.hasIcon||btn.hasIcon;return btn.key&&(t.keys[btn.key]={fn:btn.fn||btnName,param:btn.param||btnName}),t.tagToButton[(btn.tag||btnName).toLowerCase()]=btnName,$("<button/>",{type:"button",class:prefix+btnName+"-dropdown-button"+(btn.ico?" "+prefix+btn.ico+"-button":""),html:t.hasSvg&&hasIcon?'<svg><use xlink:href="'+t.svgPath+"#"+prefix+(btn.ico||btnName).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>'+(btn.text||btn.title||t.lang[btnName]||btnName):btn.text||btn.title||t.lang[btnName]||btnName,title:btn.key?" (Ctrl + "+btn.key+")":null,style:btn.style||null,mousedown:function(){return $("body",t.doc).trigger("mousedown"),t.execCmd(btn.fn||btnName,btn.param||btnName,btn.forceCss),!1}})},isSupportedBtn:function(b){try{return this.btnsDef[b].isSupported()}catch(c){}return!0},buildOverlay:function(){var t=this;return t.$overlay=$("<div/>",{class:t.o.prefix+"overlay"}).appendTo(t.$box),t.$overlay},showOverlay:function(){var t=this;$(window).trigger("scroll"),t.$overlay.fadeIn(200),t.$box.addClass(t.o.prefix+"box-blur")},hideOverlay:function(){var t=this;t.$overlay.fadeOut(50),t.$box.removeClass(t.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){var t=this,fixedFullWidth=t.o.fixedFullWidth,$box=t.$box;t.o.fixedBtnPane&&(t.isFixed=!1,$(window).on("scroll."+t.eventNamespace+" resize."+t.eventNamespace,function(){if($box){t.syncCode();var scrollTop=$(window).scrollTop(),offset=$box.offset().top+1,bp=t.$btnPane,oh=bp.outerHeight()-2;scrollTop-offset>0&&scrollTop-offset-t.height<0?(t.isFixed||(t.isFixed=!0,bp.css({position:"fixed",top:0,left:fixedFullWidth?"0":"auto",zIndex:7}),$([t.$ta,t.$ed]).css({marginTop:bp.height()})),bp.css({width:fixedFullWidth?"100%":$box.width()-1+"px"}),$("."+t.o.prefix+"fixed-top",$box).css({position:fixedFullWidth?"fixed":"absolute",top:fixedFullWidth?oh:oh+(scrollTop-offset)+"px",zIndex:15})):t.isFixed&&(t.isFixed=!1,bp.removeAttr("style"),$([t.$ta,t.$ed]).css({marginTop:0}),$("."+t.o.prefix+"fixed-top",$box).css({position:"absolute",top:oh}))}}))},setDisabled:function(disable){var t=this,prefix=t.o.prefix;t.disabled=disable,disable?t.$ta.attr("disabled",!0):t.$ta.removeAttr("disabled"),t.$box.toggleClass(prefix+"disabled",disable),t.$ed.attr("contenteditable",!disable)},destroy:function(){var t=this,prefix=t.o.prefix;t.isTextarea?t.$box.after(t.$ta.css({height:""}).val(t.html()).removeClass(prefix+"textarea").show()):t.$box.after(t.$ed.css({height:""}).removeClass(prefix+"editor").removeAttr("contenteditable").removeAttr("dir").html(t.html()).show()),t.$ed.off("dblclick","img"),t.destroyPlugins(),t.$box.remove(),t.$c.removeData("trumbowyg"),$("body").removeClass(prefix+"body-fullscreen"),t.$c.trigger("tbwclose"),$(window).off("scroll."+t.eventNamespace+" resize."+t.eventNamespace)},empty:function(){this.$ta.val(""),this.syncCode(!0)},toggle:function(){var t=this,prefix=t.o.prefix;t.o.autogrowOnEnter&&(t.autogrowOnEnterDontClose=!t.$box.hasClass(prefix+"editor-hidden")),t.semanticCode(!1,!0),setTimeout(function(){t.doc.activeElement.blur(),t.$box.toggleClass(prefix+"editor-hidden "+prefix+"editor-visible"),t.$btnPane.toggleClass(prefix+"disable"),$("."+prefix+"viewHTML-button",t.$btnPane).toggleClass(prefix+"active"),t.$box.hasClass(prefix+"editor-visible")?t.$ta.attr("tabindex",-1):t.$ta.removeAttr("tabindex"),t.o.autogrowOnEnter&&!t.autogrowOnEnterDontClose&&t.autogrowEditorOnEnter()},0)},dropdown:function(name){var t=this,d=t.doc,prefix=t.o.prefix,$dropdown=$("[data-"+prefix+"dropdown="+name+"]",t.$box),$btn=$("."+prefix+name+"-button",t.$btnPane),show=$dropdown.is(":hidden");if($("body",d).trigger("mousedown"),show){var o=$btn.offset().left;$btn.addClass(prefix+"active"),$dropdown.css({position:"absolute",top:$btn.offset().top-t.$btnPane.offset().top+$btn.outerHeight(),left:t.o.fixedFullWidth&&t.isFixed?o+"px":o-t.$btnPane.offset().left+"px"}).show(),$(window).trigger("scroll"),$("body",d).on("mousedown."+t.eventNamespace,function(e){$dropdown.is(e.target)||($("."+prefix+"dropdown",t.$box).hide(),$("."+prefix+"active",t.$btnPane).removeClass(prefix+"active"),$("body",d).off("mousedown."+t.eventNamespace))})}},html:function(html){var t=this;return null!=html?(t.$ta.val(html),t.syncCode(!0),t.$c.trigger("tbwchange"),t):t.$ta.val()},syncTextarea:function(){var t=this;t.$ta.val(t.$ed.text().trim().length>0||t.$ed.find(t.o.tagsToKeep.join(",")).length>0?t.$ed.html():"")},syncCode:function(force){var t=this;if(!force&&t.$ed.is(":visible"))t.syncTextarea();else{var html=$("<div>").html(t.$ta.val()),safe=$("<div>").append(html);$(t.o.tagsToRemove.join(","),safe).remove(),t.$ed.html(safe.contents().html())}if(t.o.autogrow&&(t.height=t.$ed.height(),t.height!==t.$ta.css("height")&&(t.$ta.css({height:t.height}),t.$c.trigger("tbwresize"))),t.o.autogrowOnEnter){t.$ed.height("auto");var totalheight=t.autogrowOnEnterWasFocused?t.$ed[0].scrollHeight:t.$ed.css("min-height");totalheight!==t.$ta.css("height")&&(t.$ed.css({height:totalheight}),t.$c.trigger("tbwresize"))}},semanticCode:function(force,full,keepRange){var t=this;if(t.saveRange(),t.syncCode(force),t.o.semantic){if(t.semanticTag("b"),t.semanticTag("i"),t.semanticTag("s"),t.semanticTag("strike"),full){var inlineElementsSelector=t.o.inlineElementsSelector,blockElementsSelector=":not("+inlineElementsSelector+")";t.$ed.contents().filter(function(){return 3===this.nodeType&&this.nodeValue.trim().length>0}).wrap("<span data-tbw/>");var wrapInlinesInParagraphsFrom=function($from){if(0!==$from.length){var $finalParagraph=$from.nextUntil(blockElementsSelector).addBack().wrapAll("<p/>").parent(),$nextElement=$finalParagraph.nextAll(inlineElementsSelector).first();$finalParagraph.next("br").remove(),wrapInlinesInParagraphsFrom($nextElement)}};wrapInlinesInParagraphsFrom(t.$ed.children(inlineElementsSelector).first()),t.semanticTag("div",!0),t.$ed.find("p").filter(function(){return(!t.range||this!==t.range.startContainer)&&(0===$(this).text().trim().length&&0===$(this).children().not("br,span").length)}).contents().unwrap(),$("[data-tbw]",t.$ed).contents().unwrap(),t.$ed.find("p:empty").remove()}keepRange||t.restoreRange(),t.syncTextarea()}},semanticTag:function(oldTag,copyAttributes){var newTag;if(null!=this.o.semantic&&"object"==typeof this.o.semantic&&this.o.semantic.hasOwnProperty(oldTag))newTag=this.o.semantic[oldTag];else{if(!0!==this.o.semantic||!this.DEFAULT_SEMANTIC_MAP.hasOwnProperty(oldTag))return;newTag=this.DEFAULT_SEMANTIC_MAP[oldTag]}$(oldTag,this.$ed).each(function(){var $oldTag=$(this);if(0===$oldTag.contents().length)return!1;$oldTag.wrap("<"+newTag+"/>"),copyAttributes&&$.each($oldTag.prop("attributes"),function(){$oldTag.parent().attr(this.name,this.value)}),$oldTag.contents().unwrap()})},createLink:function(){for(var url,title,target,t=this,documentSelection=t.doc.getSelection(),node=documentSelection.focusNode,text=(new XMLSerializer).serializeToString(documentSelection.getRangeAt(0).cloneContents());["A","DIV"].indexOf(node.nodeName)<0;)node=node.parentNode;if(node&&"A"===node.nodeName){var $a=$(node);text=$a.text(),url=$a.attr("href"),t.o.minimalLinks||(title=$a.attr("title"),target=$a.attr("target"));var range=t.doc.createRange();range.selectNode(node),documentSelection.removeAllRanges(),documentSelection.addRange(range)}t.saveRange();var options={url:{label:"URL",required:!0,value:url},text:{label:t.lang.text,value:text}};t.o.minimalLinks||Object.assign(options,{title:{label:t.lang.title,value:title},target:{label:t.lang.target,value:target}}),t.openModalInsert(t.lang.createLink,options,function(v){var url=t.prependUrlPrefix(v.url);if(!url.length)return!1;var link=$(['<a href="',url,'">',v.text||v.url,"</a>"].join(""));return t.o.minimalLinks||(v.title.length>0&&link.attr("title",v.title),v.target.length>0&&link.attr("target",v.target)),t.range.deleteContents(),t.range.insertNode(link[0]),t.syncCode(),t.$c.trigger("tbwchange"),!0})},prependUrlPrefix:function(url){if(!this.urlPrefix)return url;if(/^([a-z][-+.a-z0-9]*:|\/|#)/i.test(url))return url;return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(url)?"mailto:"+url:this.urlPrefix+url},unlink:function(){var t=this,documentSelection=t.doc.getSelection(),node=documentSelection.focusNode;if(documentSelection.isCollapsed){for(;["A","DIV"].indexOf(node.nodeName)<0;)node=node.parentNode;if(node&&"A"===node.nodeName){var range=t.doc.createRange();range.selectNode(node),documentSelection.removeAllRanges(),documentSelection.addRange(range)}}t.execCmd("unlink",void 0,void 0,!0)},insertImage:function(){var t=this;t.saveRange();var options={url:{label:"URL",required:!0},alt:{label:t.lang.description,value:t.getRangeText()}};t.o.imageWidthModalEdit&&(options.width={}),t.openModalInsert(t.lang.insertImage,options,function(v){t.execCmd("insertImage",v.url,!1,!0);var $img=$('img[src="'+v.url+'"]:not([alt])',t.$box);return $img.attr("alt",v.alt),t.o.imageWidthModalEdit&&$img.attr({width:v.width}),t.syncCode(),t.$c.trigger("tbwchange"),!0})},fullscreen:function(){var isFullscreen,t=this,prefix=t.o.prefix,fullscreenCssClass=prefix+"fullscreen";t.$box.toggleClass(fullscreenCssClass),isFullscreen=t.$box.hasClass(fullscreenCssClass),$("body").toggleClass(prefix+"body-fullscreen",isFullscreen),$(window).trigger("scroll"),t.$c.trigger("tbw"+(isFullscreen?"open":"close")+"fullscreen")},execCmd:function(cmd,param,forceCss,skipTrumbowyg){var t=this;skipTrumbowyg=!!skipTrumbowyg||"","dropdown"!==cmd&&t.$ed.focus();try{t.doc.execCommand("styleWithCSS",!1,forceCss||!1)}catch(c){}try{t[cmd+skipTrumbowyg](param)}catch(c){try{cmd(param)}catch(e2){"insertHorizontalRule"===cmd?param=void 0:"formatBlock"===cmd&&t.isIE&&(param="<"+param+">"),t.doc.execCommand(cmd,!1,param),t.syncCode(),t.semanticCode(!1,!0)}"dropdown"!==cmd&&(t.updateButtonPaneStatus(),t.$c.trigger("tbwchange"))}},openModal:function(title,content){var t=this,prefix=t.o.prefix;if($("."+prefix+"modal-box",t.$box).length>0)return!1;t.o.autogrowOnEnter&&(t.autogrowOnEnterDontClose=!0),t.saveRange(),t.showOverlay(),t.$btnPane.addClass(prefix+"disable");var $modal=$("<div/>",{class:prefix+"modal "+prefix+"fixed-top"}).css({top:t.$box.offset().top+t.$btnPane.height(),zIndex:99999}).appendTo($(t.doc.body));t.$overlay.one("click",function(){return $modal.trigger("tbwcancel"),!1});var $form=$("<form/>",{action:"",html:content}).on("submit",function(){return $modal.trigger("tbwconfirm"),!1}).on("reset",function(){return $modal.trigger("tbwcancel"),!1}).on("submit reset",function(){t.o.autogrowOnEnter&&(t.autogrowOnEnterDontClose=!1)}),$box=$("<div/>",{class:prefix+"modal-box",html:$form}).css({top:"-"+t.$btnPane.outerHeight()+"px",opacity:0}).appendTo($modal).animate({top:0,opacity:1},100);return $("<span/>",{text:title,class:prefix+"modal-title"}).prependTo($box),$modal.height($box.outerHeight()+10),$("input:first",$box).focus(),t.buildModalBtn("submit",$box),t.buildModalBtn("reset",$box),$(window).trigger("scroll"),$modal},buildModalBtn:function(n,$modal){var prefix=this.o.prefix;return $("<button/>",{class:prefix+"modal-button "+prefix+"modal-"+n,type:n,text:this.lang[n]||n}).appendTo($("form",$modal))},closeModal:function(){var t=this,prefix=t.o.prefix;t.$btnPane.removeClass(prefix+"disable"),t.$overlay.off();var $modalBox=$("."+prefix+"modal-box",$(document.body));$modalBox.animate({top:"-"+$modalBox.height()},100,function(){$modalBox.parent().remove(),t.hideOverlay()}),t.restoreRange()},openModalInsert:function(title,fields,cmd){var t=this,prefix=t.o.prefix,lg=t.lang,html="";return $.each(fields,function(fieldName,field){var l=field.label||fieldName,n=field.name||fieldName,a=field.attributes||{},attr=Object.keys(a).map(function(prop){return prop+'="'+a[prop]+'"'}).join(" ");html+='<label><input type="'+(field.type||"text")+'" name="'+n+'"'+("checkbox"===field.type&&field.value?' checked="checked"':' value="'+(field.value||"").replace(/"/g,"&quot;"))+'"'+attr+'><span class="'+prefix+'input-infos"><span>'+(lg[l]?lg[l]:l)+"</span></span></label>"}),t.openModal(title,html).on("tbwconfirm",function(){var $form=$("form",$(this)),valid=!0,values={};$.each(fields,function(fieldName,field){var n=field.name||fieldName,$field=$('input[name="'+n+'"]',$form);switch($field.attr("type").toLowerCase()){case"checkbox":values[n]=$field.is(":checked");break;case"radio":values[n]=$field.filter(":checked").val();break;default:values[n]=$.trim($field.val())}field.required&&""===values[n]?(valid=!1,t.addErrorOnModalField($field,t.lang.required)):field.pattern&&!field.pattern.test(values[n])&&(valid=!1,t.addErrorOnModalField($field,field.patternError))}),valid&&(t.restoreRange(),cmd(values,fields)&&(t.syncCode(),t.$c.trigger("tbwchange"),t.closeModal(),$(this).off("tbwconfirm")))}).one("tbwcancel",function(){$(this).off("tbwconfirm"),t.closeModal()})},addErrorOnModalField:function($field,err){var prefix=this.o.prefix,$label=$field.parent();$field.on("change keyup",function(){$label.removeClass(prefix+"input-error")}),$label.addClass(prefix+"input-error").find("input+span").append($("<span/>",{class:prefix+"msg-error",text:err}))},getDefaultImgDblClickHandler:function(){var t=this;return function(){var $img=$(this),src=$img.attr("src");0===src.indexOf("data:image")&&(src="(Base64)");var options={url:{label:"URL",value:src,required:!0},alt:{label:t.lang.description,value:$img.attr("alt")}};return t.o.imageWidthModalEdit&&(options.width={value:$img.attr("width")?$img.attr("width"):""}),t.openModalInsert(t.lang.insertImage,options,function(v){return"(Base64)"!==v.url&&$img.attr({src:v.url}),$img.attr({alt:v.alt}),t.o.imageWidthModalEdit&&(parseInt(v.width)>0?$img.attr({width:v.width}):$img.removeAttr("width")),!0}),!1}},saveRange:function(){var t=this,documentSelection=t.doc.getSelection();if(t.range=null,documentSelection&&documentSelection.rangeCount){var rangeStart,savedRange=t.range=documentSelection.getRangeAt(0),range=t.doc.createRange();range.selectNodeContents(t.$ed[0]),range.setEnd(savedRange.startContainer,savedRange.startOffset),rangeStart=(range+"").length,t.metaRange={start:rangeStart,end:rangeStart+(savedRange+"").length}}},restoreRange:function(){var range,t=this,metaRange=t.metaRange,savedRange=t.range,documentSelection=t.doc.getSelection();if(savedRange){if(metaRange&&metaRange.start!==metaRange.end){var node,charIndex=0,nodeStack=[t.$ed[0]],foundStart=!1,stop=!1;for(range=t.doc.createRange();!stop&&(node=nodeStack.pop());)if(3===node.nodeType){var nextCharIndex=charIndex+node.length;!foundStart&&metaRange.start>=charIndex&&metaRange.start<=nextCharIndex&&(range.setStart(node,metaRange.start-charIndex),foundStart=!0),foundStart&&metaRange.end>=charIndex&&metaRange.end<=nextCharIndex&&(range.setEnd(node,metaRange.end-charIndex),stop=!0),charIndex=nextCharIndex}else for(var cn=node.childNodes,i=cn.length;i>0;)i-=1,nodeStack.push(cn[i])}documentSelection.removeAllRanges(),documentSelection.addRange(range||savedRange)}},getRangeText:function(){return this.range+""},updateButtonPaneStatus:function(){var t=this,prefix=t.o.prefix,tags=t.getTagsRecursive(t.doc.getSelection().focusNode),activeClasses=prefix+"active-button "+prefix+"active";$("."+prefix+"active-button",t.$btnPane).removeClass(activeClasses),$.each(tags,function(i,tag){var btnName=t.tagToButton[tag.toLowerCase()],$btn=$("."+prefix+btnName+"-button",t.$btnPane);if($btn.length>0)$btn.addClass(activeClasses);else try{var dropdownBtnName=($btn=$("."+prefix+"dropdown ."+prefix+btnName+"-dropdown-button",t.$box)).parent().data("dropdown");$("."+prefix+dropdownBtnName+"-button",t.$box).addClass(activeClasses)}catch(e){}})},getTagsRecursive:function(element,tags){var t=this;if(tags=tags||(element&&element.tagName?[element.tagName]:[]),!element||!element.parentNode)return tags;var tag=(element=element.parentNode).tagName;return"DIV"===tag?tags:("P"===tag&&""!==element.style.textAlign&&tags.push(element.style.textAlign),$.each(t.tagHandlers,function(i,tagHandler){tags=tags.concat(tagHandler(element,t))}),tags.push(tag),t.getTagsRecursive(element,tags).filter(function(tag){return null!=tag}))},initPlugins:function(){var t=this;t.loadedPlugins=[],$.each($.trumbowyg.plugins,function(name,plugin){plugin.shouldInit&&!plugin.shouldInit(t)||(plugin.init(t),plugin.tagHandler&&t.tagHandlers.push(plugin.tagHandler),t.loadedPlugins.push(plugin))})},destroyPlugins:function(){$.each(this.loadedPlugins,function(i,plugin){plugin.destroy&&plugin.destroy()})}}}(navigator,window,document,jQuery);